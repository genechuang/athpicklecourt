name: Daily Court Booking

on:
  schedule:
    # Runs at 11:59 PM PST daily (7:59 AM UTC) to warm up before 12:00:15 AM booking time
    # Format: minute hour day month weekday
    # The workflow file uses UTC time. To convert your local time to UTC:
    # - **Pacific Time (PST)**: 11:59 PM PST = 7:59 AM UTC next day
    # - **Pacific Time (PDT)**: 11:59 PM PDT = 6:59 AM UTC next day
    # Note: During PDT (March-November), use '59 6 * * *'
    # Note: During PST (November-March), use '59 7 * * *'

    - cron: '59 7 * * *'  # 11:59 PM PST (adjust for PDT/PST)

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      date:
        description: 'Booking date (MM/DD/YYYY)'
        required: false
      time:
        description: 'Booking time (e.g., "10:00 AM")'
        required: false
      court:
        description: 'Court name'
        required: false
      duration:
        description: 'Duration in minutes (60 or 120)'
        required: false

jobs:
  book-court:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install playwright python-dotenv pytz
        playwright install chromium
        playwright install-deps chromium

    - name: Create .env file from secrets and variables
      run: |
        # Secrets (sensitive credentials)
        echo "ATHENAEUM_USERNAME=${{ secrets.ATHENAEUM_USERNAME }}" >> .env
        echo "ATHENAEUM_PASSWORD=${{ secrets.ATHENAEUM_PASSWORD }}" >> .env

        # Variables (non-sensitive configuration)
        echo "BOOKING_LIST=${{ vars.BOOKING_LIST }}" >> .env
        echo "COURT_NAME=${{ vars.COURT_NAME }}" >> .env
        echo "BOOKING_DURATION=${{ vars.BOOKING_DURATION }}" >> .env
        echo "SAFETY_MODE=${{ vars.SAFETY_MODE || 'False' }}" >> .env
        echo "HEADLESS=${{ vars.HEADLESS || 'True' }}" >> .env

    - name: Run booking script with current timestamp
      run: |
        INVOKE_TIME=$(date -u +"%m-%d-%Y %H:%M:%S")
        echo "Invoke time (UTC): $INVOKE_TIME"

        if [ -n "${{ github.event.inputs.date }}" ]; then
          # Manual trigger with custom parameters
          python ath-booking.py \
            --date "${{ github.event.inputs.date }}" \
            --time "${{ github.event.inputs.time }}" \
            --court "${{ github.event.inputs.court }}" \
            --duration "${{ github.event.inputs.duration }}"
        else
          # Scheduled trigger with invoke time for booking list processing
          python ath-booking.py --invoke-time "$INVOKE_TIME"
        fi

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-screenshots-${{ github.run_number }}
        path: '*.png'
        retention-days: 7

    - name: Notify on failure
      if: failure()
      run: |
        echo "Booking failed! Check the logs and screenshots."
