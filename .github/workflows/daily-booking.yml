name: Daily Court Booking

on:
  schedule:
    # Court booking: 11:45 PM PST (7:45 AM UTC next day)
    - cron: '45 7 * * *'
    # Court booking backup: 12:00 AM PST (8:00 AM UTC)
    - cron: '00 8 * * *'
    # Payment/voting reminders: 10:00 AM PST (6:00 PM UTC)
    - cron: '0 18 * * *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Which job to run'
        type: choice
        options:
          - court-booking
          - payment-reminders
        default: 'court-booking'
      booking_date_time:
        description: 'Booking date and time (MM/DD/YYYY HH:MM AM/PM)'
        required: false
      court:
        description: 'Court name'
        required: false
      duration:
        description: 'Duration in minutes (60 or 120)'
        required: false
      booking_list:
        description: 'Booking list (e.g., "Tuesday 7:00 PM,Friday 4:00 PM") - overrides single booking'
        required: false
      booking_target_time:
        description: 'Target booking time (HH:MM:SS, e.g., "10:05:30" for debugging)'
        required: false
        default: '00:00:15'
      safety_mode:
        description: 'Safety mode (True/False) - True stops before booking'
        required: false
        default: 'True'
      dry_run:
        description: 'Dry run mode for payment reminders'
        type: boolean
        required: false
        default: false

jobs:
  book-court:
    runs-on: ubuntu-latest
    if: >
      github.event.schedule == '45 7 * * *' ||
      github.event.schedule == '00 8 * * *' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'court-booking')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps chromium

    - name: Create .env file from secrets and variables
      run: |
        # Secrets (sensitive credentials)
        echo "ATHENAEUM_USERNAME=${{ secrets.ATHENAEUM_USERNAME }}" >> .env
        echo "ATHENAEUM_PASSWORD=${{ secrets.ATHENAEUM_PASSWORD }}" >> .env

        # Email notification secrets (optional)
        echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" >> .env
        echo "GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}" >> .env
        echo "NOTIFICATION_EMAIL=${{ secrets.NOTIFICATION_EMAIL }}" >> .env

        # WhatsApp notification secrets (optional - for Admin Dinkers group)
        echo "GREENAPI_INSTANCE_ID=${{ secrets.GREENAPI_INSTANCE_ID }}" >> .env
        echo "GREENAPI_API_TOKEN=${{ secrets.GREENAPI_API_TOKEN }}" >> .env
        echo "ADMIN_DINKERS_WHATSAPP_GROUP_ID=${{ vars.ADMIN_DINKERS_WHATSAPP_GROUP_ID }}" >> .env

        # Variables (non-sensitive configuration)
        echo "BOOKING_LIST=${{ github.event.inputs.booking_list || vars.BOOKING_LIST }}" >> .env
        echo "BOOKING_TARGET_TIME=${{ github.event.inputs.booking_target_time || vars.BOOKING_TARGET_TIME || '00:01:01' }}" >> .env
        echo "COURT_NAME=${{ vars.COURT_NAME }}" >> .env
        echo "BOOKING_DURATION=${{ vars.BOOKING_DURATION }}" >> .env
        echo "SAFETY_MODE=${{ github.event.inputs.safety_mode || vars.SAFETY_MODE || 'False' }}" >> .env
        echo "HEADLESS=${{ vars.HEADLESS || 'True' }}" >> .env

    - name: Run booking script with current timestamp
      run: |
        # Generate timestamp in PST/PDT timezone
        INVOKE_TIME=$(TZ='America/Los_Angeles' date +"%m-%d-%Y %H:%M:%S")
        echo "Invoke time (PST/PDT): $INVOKE_TIME"

        if [ -n "${{ github.event.inputs.booking_date_time }}" ]; then
          # Manual trigger with custom parameters
          python -u ath-booking.py \
            --booking-date-time "${{ github.event.inputs.booking_date_time }}" \
            --court "${{ github.event.inputs.court }}" \
            --duration "${{ github.event.inputs.duration }}"
        else
          # Scheduled trigger with invoke time for booking list processing
          python -u ath-booking.py --invoke-time "$INVOKE_TIME"
        fi

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-screenshots-${{ github.run_number }}
        path: '*.png'
        retention-days: 7

    - name: Notify on failure
      if: failure()
      run: |
        echo "Booking failed! Check the logs and screenshots."

  payment-reminders:
    runs-on: ubuntu-latest
    if: >
      github.event.schedule == '0 18 * * *' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'payment-reminders')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create .env file from secrets and variables
      run: |
        # WhatsApp credentials
        echo "GREENAPI_INSTANCE_ID=${{ secrets.GREENAPI_INSTANCE_ID }}" >> .env
        echo "GREENAPI_API_TOKEN=${{ secrets.GREENAPI_API_TOKEN }}" >> .env
        echo "SMAD_WHATSAPP_GROUP_ID=${{ vars.SMAD_WHATSAPP_GROUP_ID }}" >> .env
        echo "SMAD_WHATSAPP_GROUP_URL=${{ vars.SMAD_WHATSAPP_GROUP_URL }}" >> .env
        echo "ADMIN_DINKERS_WHATSAPP_GROUP_ID=${{ vars.ADMIN_DINKERS_WHATSAPP_GROUP_ID }}" >> .env

        # Google Sheets credentials
        echo "SMAD_SPREADSHEET_ID=${{ vars.SMAD_SPREADSHEET_ID }}" >> .env
        echo "SMAD_SHEET_NAME=${{ vars.SMAD_SHEET_NAME }}" >> .env

        # Email notification
        echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" >> .env
        echo "GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}" >> .env

        # Venmo credentials
        echo "VENMO_ACCESS_TOKEN=${{ secrets.VENMO_ACCESS_TOKEN }}" >> .env

        # Booking list (for poll generation context)
        echo "BOOKING_LIST=${{ vars.BOOKING_LIST }}" >> .env

    - name: Create Google credentials file
      run: |
        echo '${{ secrets.SMAD_GOOGLE_CREDENTIALS_JSON }}' > smad-credentials.json

    - name: Set dry run flag
      id: dry_run
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "flag=--dry-run" >> $GITHUB_OUTPUT
        else
          echo "flag=" >> $GITHUB_OUTPUT
        fi

    - name: Run payment and voting reminders
      run: |
        DRY_RUN="${{ steps.dry_run.outputs.flag }}"

        echo "=========================================="
        echo "Daily WhatsApp Automation"
        echo "Time (PST): $(TZ='America/Los_Angeles' date)"
        echo "Dry Run: ${{ github.event.inputs.dry_run }}"
        echo "=========================================="

        echo ""
        echo "=== Step 1: Syncing Venmo Payments ==="
        python -u payments-management.py sync-venmo $DRY_RUN

        echo ""
        echo "=== Step 2: Sending Payment Reminders ==="
        python -u smad-whatsapp.py $DRY_RUN send-balance-dm all

        echo ""
        echo "=== Step 3: Sending Vote Reminders ==="
        python -u smad-whatsapp.py $DRY_RUN send-vote-reminders

        echo ""
        echo "=== Daily Automation Complete ==="

    - name: Notify on failure
      if: failure()
      run: |
        echo "Daily WhatsApp automation failed! Check the logs."
