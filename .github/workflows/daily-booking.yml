name: Daily Court Booking

on:
  schedule:
    # Primary: Runs at 11:50 PM PST daily (7:50 AM UTC) to warm up before 12:00:15 AM booking time
    # Scheduled 10 minutes early to avoid midnight GitHub Actions contention (2-5 min delays common)
    # Script has 10-minute grace period - if it starts late, it books immediately instead of waiting 24 hours
    # Format: minute hour day month weekday
    # The workflow file uses UTC time. To convert your local time to UTC:
    # - **Pacific Time (PST)**: 11:50 PM PST = 7:50 AM UTC next day
    # - **Pacific Time (PDT)**: 11:50 PM PDT = 6:50 AM UTC next day
    # Note: During PDT (March-November), use '50 6 * * *'
    # Note: During PST (November-March), use '50 7 * * *'
    - cron: '50 6 * * *'  # 11:50 PM PST (adjust for PDT/PST)

    # Backup: Runs at 12:01 AM PST daily (8:01 AM UTC) as fallback
    # If primary trigger didn't complete bookings (e.g., courts not released yet), this retries
    # - **Pacific Time (PST)**: 12:01 AM PST = 8:01 AM UTC same day
    # - **Pacific Time (PDT)**: 12:01 AM PDT = 7:01 AM UTC same day
    # Note: During PDT (March-November), use '01 7 * * *'
    # Note: During PST (November-March), use '01 8 * * *'
    - cron: '01 8 * * *'  # 12:01 AM PST (adjust for PDT/PST)

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      date:
        description: 'Booking date (MM/DD/YYYY)'
        required: false
      time:
        description: 'Booking time (e.g., "10:00 AM")'
        required: false
      court:
        description: 'Court name'
        required: false
      duration:
        description: 'Duration in minutes (60 or 120)'
        required: false
      booking_list:
        description: 'Booking list (e.g., "Tuesday 7:00 PM,Friday 4:00 PM") - overrides single booking'
        required: false
      booking_target_time:
        description: 'Target booking time (HH:MM:SS, e.g., "10:05:30" for debugging)'
        required: false
        default: '00:00:15'
      safety_mode:
        description: 'Safety mode (True/False) - True stops before booking'
        required: false
        default: 'True'

jobs:
  book-court:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install playwright python-dotenv pytz
        playwright install chromium
        playwright install-deps chromium

    - name: Create .env file from secrets and variables
      run: |
        # Secrets (sensitive credentials)
        echo "ATHENAEUM_USERNAME=${{ secrets.ATHENAEUM_USERNAME }}" >> .env
        echo "ATHENAEUM_PASSWORD=${{ secrets.ATHENAEUM_PASSWORD }}" >> .env

        # Email notification secrets (optional)
        echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" >> .env
        echo "GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}" >> .env
        echo "NOTIFICATION_EMAIL=${{ secrets.NOTIFICATION_EMAIL }}" >> .env

        # Variables (non-sensitive configuration)
        echo "BOOKING_LIST=${{ github.event.inputs.booking_list || vars.BOOKING_LIST }}" >> .env
        echo "BOOKING_TARGET_TIME=${{ github.event.inputs.booking_target_time || vars.BOOKING_TARGET_TIME || '00:00:15' }}" >> .env
        echo "COURT_NAME=${{ vars.COURT_NAME }}" >> .env
        echo "BOOKING_DURATION=${{ vars.BOOKING_DURATION }}" >> .env
        echo "SAFETY_MODE=${{ github.event.inputs.safety_mode || vars.SAFETY_MODE || 'False' }}" >> .env
        echo "HEADLESS=${{ vars.HEADLESS || 'True' }}" >> .env

    - name: Run booking script with current timestamp
      run: |
        # Generate timestamp in PST/PDT timezone
        INVOKE_TIME=$(TZ='America/Los_Angeles' date +"%m-%d-%Y %H:%M:%S")
        echo "Invoke time (PST/PDT): $INVOKE_TIME"

        if [ -n "${{ github.event.inputs.date }}" ]; then
          # Manual trigger with custom parameters
          python ath-booking.py \
            --date "${{ github.event.inputs.date }}" \
            --time "${{ github.event.inputs.time }}" \
            --court "${{ github.event.inputs.court }}" \
            --duration "${{ github.event.inputs.duration }}"
        else
          # Scheduled trigger with invoke time for booking list processing
          python ath-booking.py --invoke-time "$INVOKE_TIME"
        fi

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-screenshots-${{ github.run_number }}
        path: '*.png'
        retention-days: 7

    - name: Notify on failure
      if: failure()
      run: |
        echo "Booking failed! Check the logs and screenshots."
