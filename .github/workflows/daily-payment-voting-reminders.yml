name: Daily WhatsApp Automation (Payments & Votes)

on:
  schedule:
    # Runs every day at 10:00 AM PST
    # PST (Nov-Mar): 10:00 AM PST = 6:00 PM UTC same day
    # PDT (Mar-Nov): 10:00 AM PDT = 5:00 PM UTC same day
    # Format: minute hour day month weekday
    # Note: During PDT (March-November), use '0 17 * * *'
    # Note: During PST (November-March), use '0 18 * * *'
    - cron: '0 18 * * *'  # 10:00 AM PST (adjust for PDT/PST)

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (preview without sending)'
        type: boolean
        required: false
        default: false
      poll_created_date:
        description: 'Poll created date (M/D/YY format, e.g., 1/19/26) - optional override for edge cases'
        type: string
        required: false
        default: ''

jobs:
  daily-automation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create .env file from secrets and variables
      run: |
        # WhatsApp credentials
        echo "GREENAPI_INSTANCE_ID=${{ secrets.GREENAPI_INSTANCE_ID }}" >> .env
        echo "GREENAPI_API_TOKEN=${{ secrets.GREENAPI_API_TOKEN }}" >> .env
        echo "SMAD_WHATSAPP_GROUP_ID=${{ vars.SMAD_WHATSAPP_GROUP_ID }}" >> .env
        echo "SMAD_WHATSAPP_GROUP_URL=${{ vars.SMAD_WHATSAPP_GROUP_URL }}" >> .env

        # Google Sheets credentials
        echo "SMAD_SPREADSHEET_ID=${{ vars.SMAD_SPREADSHEET_ID }}" >> .env
        echo "SMAD_SHEET_NAME=${{ vars.SMAD_SHEET_NAME }}" >> .env

        # Email notification
        echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" >> .env
        echo "GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}" >> .env

        # Venmo credentials
        echo "VENMO_ACCESS_TOKEN=${{ secrets.VENMO_ACCESS_TOKEN }}" >> .env

        # Booking list (for poll generation context)
        echo "BOOKING_LIST=${{ vars.BOOKING_LIST }}" >> .env

        # Poll created date (optional override for edge cases)
        # Priority: workflow input > GitHub variable
        if [ -n "${{ github.event.inputs.poll_created_date }}" ]; then
          echo "POLL_CREATED_DATE=${{ github.event.inputs.poll_created_date }}" >> .env
        elif [ -n "${{ vars.POLL_CREATED_DATE }}" ]; then
          echo "POLL_CREATED_DATE=${{ vars.POLL_CREATED_DATE }}" >> .env
        fi

    - name: Create Google credentials file
      run: |
        echo '${{ secrets.SMAD_GOOGLE_CREDENTIALS_JSON }}' > smad-credentials.json

    - name: Set dry run flag
      id: dry_run
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "flag=--dry-run" >> $GITHUB_OUTPUT
        else
          echo "flag=" >> $GITHUB_OUTPUT
        fi

    - name: Run daily automation
      run: |
        DRY_RUN="${{ steps.dry_run.outputs.flag }}"

        echo "=========================================="
        echo "Daily WhatsApp Automation"
        echo "Time (PST): $(TZ='America/Los_Angeles' date)"
        echo "Dry Run: ${{ github.event.inputs.dry_run }}"
        if [ -n "${{ github.event.inputs.poll_created_date }}" ]; then
          echo "Poll Created Date Override (input): ${{ github.event.inputs.poll_created_date }}"
        elif [ -n "${{ vars.POLL_CREATED_DATE }}" ]; then
          echo "Poll Created Date Override (variable): ${{ vars.POLL_CREATED_DATE }}"
        fi
        echo "=========================================="

        echo ""
        echo "=== Step 1: Syncing Venmo Payments ==="
        python -u payments-management.py sync-venmo $DRY_RUN

        echo ""
        echo "=== Step 2: Sending Payment Reminders ==="
        python -u smad-whatsapp.py $DRY_RUN send-balance-dm all

        echo ""
        echo "=== Step 3: Sending Vote Reminders ==="
        python -u smad-whatsapp.py $DRY_RUN send-vote-reminders

        echo ""
        echo "=== Daily Automation Complete ==="

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-automation-logs-${{ github.run_number }}
        path: |
          *.log
          *.json
        retention-days: 7
        if-no-files-found: ignore

    - name: Notify on failure
      if: failure()
      run: |
        echo "Daily WhatsApp automation failed! Check the logs."
