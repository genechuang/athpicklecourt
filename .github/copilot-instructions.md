# AI Copilot Instructions for SMADPickleBot

This codebase is a multi-service pickleball automation platform for court bookings and player management. Below is essential context for AI agents to be immediately productive.

## Project Architecture

**Three independent services sharing common utilities:**

1. **Athenaeum Court Booking** (`ath-booking.py`) - Playwright-based browser automation
   - Logs into Athenaeum member portal and books pickleball courts
   - Runs via GitHub Actions daily at 11:50 PM PST (primary) + 12:01 AM PST (backup)
   - **Critical timing**: Waits until exactly 12:00:15 AM PST when courts become available 7 days out
   - Supports both automated weekly schedules (`BOOKING_LIST`) and manual single bookings (`BOOKING_DATE_TIME`)
   - Sends email notifications with screenshots on booking success/failure

2. **SMAD Google Sheets Automation** (`smad-sheets.py`) - Read/write to shared Google Sheets
   - Manages player hours, balances, and payment tracking
   - Registers game attendance, creates new date columns, sends payment reminders
   - **Data model**: Column indices are fixed (COL_FIRST_NAME=0, COL_LAST_NAME=1... COL_FIRST_DATE=13+)
   - Uses Google Sheets API with service account authentication (JSON credentials file)

3. **SMAD WhatsApp Integration** (`smad-whatsapp.py`) - GREEN-API for WhatsApp messaging
   - Sends balance reminders to players via DM and group summaries
   - Creates/manages availability polls for upcoming games
   - **Shared column indices** with smad-sheets.py - keep in sync!
   - Uses GREEN-API (WhatsApp API service)

4. **WhatsApp Poll Webhook** (`webhook/main.py`) - Google Cloud Function
   - Receives poll vote updates from GREEN-API and stores in Firestore
   - Implements "cannot play" override logic (if user selects both play dates and "I cannot play", keep only "cannot play")
   - Real-time vote tracking; Google Sheets sync via `smad-sheets.py sync-votes` command

**Common Utilities:**
- `email_service.py` - Shared Gmail SMTP module for booking notifications, payment reminders, balance summaries
- `requirements.txt` - Playwright, Google APIs, WhatsApp client, Firestore, python-dotenv

## Critical Developer Patterns

### Environment Configuration
- All services use `.env` files (never commit - already in .gitignore)
- Configuration via environment variables; fallback defaults in code (search `os.environ.get()`)
- **Email setup**: Requires Gmail App Password (not regular password), set via `GMAIL_APP_PASSWORD`

### Structured Logging ("Twelve-Factor App" pattern)
- `ath-booking.py` uses JSON-formatted logging to stdout/stderr (see `log()` function at line ~30)
- Format: `{"timestamp": "...", "level": "INFO", "message": "...", ...extra_data}`
- This is NOT standard for the other services - only Athenaeum uses it (keep it!)

### Cross-Service Shared Constants
- **Column indices** in SMAD services (smad-sheets.py + smad-whatsapp.py) must stay synchronized:
  ```python
  COL_FIRST_NAME=0, COL_LAST_NAME=1, COL_EMAIL=2, COL_MOBILE=3, COL_VENMO=4, 
  COL_ZELLE=5, COL_BALANCE=6, COL_PAID=7, COL_INVOICED=8, COL_2026_HOURS=9, 
  COL_2025_HOURS=10, COL_LAST_PAID=11, COL_LAST_VOTED=12, COL_FIRST_DATE=13
  ```
  - Changes in one file require updates in the other (and possibly webhook/main.py)

- **"Cannot play" detection**: Defined in both `smad-whatsapp.py` (line ~120) and `webhook/main.py` (line ~45)
  - Both check for phrases like "cannot play", "can't play", "not available", etc.
  - Keep lists in sync across files

### Playwright Browser Automation Specifics
- Uses **async/await** pattern (`async_playwright`)
- **JavaScript-heavy Telerik controls** - Playwright needed for RadComboBox components
- Screenshots saved at each step for debugging (e.g., `screenshot_step_X.png`)
- **Timeout handling**: Catches `PlaywrightTimeout` exceptions
- Target time synchronization: Script waits for exact booking window (12:00:15 AM PST Â± 10-minute grace period)

### Google Sheets API Integration
- Uses **Service Account** authentication (JSON credentials, never commit)
- Shares spreadsheet with service account email from credentials file
- API calls use `values().get()`, `values().update()`, `values().batchUpdate()` for efficiency
- **Batch operations** preferred over individual cell updates for performance

### GitHub Actions Workflow
- **Two triggers daily**: 11:50 PM PST (primary) + 12:01 AM PST (backup recovery)
- Secrets passed as environment variables to runner
- Timezone set explicitly: `TZ='America/Los_Angeles'` for consistent PST timestamps
- Invoke timestamp generated by workflow and passed to script

## File Organization

```
ath-booking.py              # Athenaeum court booking (~1630 lines)
smad-sheets.py              # Google Sheets management (~769 lines)
smad-whatsapp.py            # WhatsApp messaging & polls (~1489 lines)
email_service.py            # Shared email utilities (~400 lines)
webhook/main.py             # Cloud Function for poll votes (~356 lines)
webhook/deploy.{bat,sh}     # Deployment scripts
requirements.txt            # Dependencies
.env.example               # Configuration template
SMAD_SETUP.md              # Google Cloud setup guide
GITHUB_ACTION_SETUP.md     # GitHub Actions configuration
README.md                   # Athenaeum court booking overview
```

## Common Tasks for AI Agents

### Adding a new field to player tracking
1. Add column index constant to BOTH `smad-sheets.py` and `smad-whatsapp.py`
2. Update Google Sheets API query ranges if needed
3. If affecting webhook data, update `webhook/main.py` Firestore schema

### Fixing timing issues with Athenaeum booking
- Check `prepare_booking_list_mode()` function (line ~68 in ath-booking.py)
- PST timezone handling via `pytz.timezone('America/Los_Angeles')`
- 7-day-ahead math: target date = today + 7 days
- Async sleep implementation for waiting until target time

### Modifying "cannot play" behavior
- Update `CANNOT_PLAY_PHRASES` in:
  - `smad-whatsapp.py` (line ~120)
  - `webhook/main.py` (line ~45)
  - `smad-sheets.py` (line ~70) - similar logic exists there

### Email notifications
- All email sending goes through `email_service.py`
- Call `send_booking_notification()`, `send_payment_reminder()`, or `send_balance_summary()`
- Attachments: images only (pass file paths as list)
- Gracefully handles missing email configuration (returns False if not set)

## Key Dependencies & Versions

- `playwright==1.48.0` - Browser automation (async)
- `google-auth==2.27.0` - Google Cloud authentication
- `google-api-python-client==2.118.0` - Sheets & Drive APIs
- `whatsapp-api-client-python==0.0.46` - GREEN-API wrapper
- `google-cloud-firestore==2.*` - Real-time database
- `python-dotenv==1.0.0` - .env file handling
- `pytz==2025.2` - Timezone handling (critical for PST synchronization)

## Security Notes

1. **Credentials files** (`smad-credentials.json`, `.env`) are in .gitignore - never commit these
2. **Service account email** (from JSON key) must be shared editor on Google Sheet
3. **GitHub Secrets** used for Athenaeum credentials and email config
4. **Gmail App Password** (not regular password) required for SMTP
5. **GREEN-API credentials** stored in environment variables (GREENAPI_INSTANCE_ID, GREENAPI_API_TOKEN)

## Testing & Debugging

- **Safety Mode**: Set `SAFETY_MODE=True` in `.env` to log actions without actually booking courts
- **Headless Mode**: Set `HEADLESS=False` to see browser window during automation
- **Screenshot debugging**: All steps capture browser state to PNG files
- **Structured logs**: Parse JSON logs from stdout to trace execution flow
